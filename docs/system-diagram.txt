MC Fun — System Architecture
═══════════════════════════════════════════════════════════════════════════

                         ┌─────────────────────────────────────────────┐
                         │           mc-server  (remote host)         │
                         │  ┌───────────────────────────────────────┐  │
                         │  │     Incus Container: minecraft        │  │
                         │  │                                       │  │
                         │  │  ┌─────────────────────────────────┐  │  │
                         │  │  │   Minecraft Server (Java)       │  │  │
                         │  │  │   /opt/minecraft/server/        │  │  │
                         │  │  │                                 │  │  │
                         │  │  │   :25565  MC protocol (bots)    │  │  │
                         │  │  │   :25575  RCON (commands)       │  │  │
                         │  │  └────────┬──────────┬─────────────┘  │  │
                         │  └───────────┼──────────┼────────────────┘  │
                         └──────────────┼──────────┼───────────────────┘
                                        │          │
                           MC protocol  │          │  RCON (TCP)
                           (bot comms)  │          │  (server cmds)
                                        │          │
┌───────────────────────────────────────┼──────────┼───────────────────────────┐
│  MC Fun Application (Elixir/OTP)      │          │                           │
│                                       │          │                           │
│  ┌─ Engine App (mc_fun) ──────────────┼──────────┼────────────────────────┐  │
│  │                                    │          │                        │  │
│  │  ┌─────────────────┐    ┌─────────┴──────────┴─────────┐             │  │
│  │  │  McFun.PubSub   │    │        McFun.Rcon             │             │  │
│  │  │  (Phoenix.PubSub)│    │  GenServer — TCP connection   │             │  │
│  │  │                 │    │  Crashes on auth fail (fast)   │             │  │
│  │  │  Topics:        │    └──────────┬───────────────────┘             │  │
│  │  │  mc_events:*    │               │                                  │  │
│  │  │  player_statuses│               │  command/1                       │  │
│  │  │  bot:*          │               │                                  │  │
│  │  │  bot_chat       │    ┌──────────┼──────────────────────────┐      │  │
│  │  │  chat_log       │    │          │                          │      │  │
│  │  └───┬──────┬──────┘    │    ┌─────┴────┐  ┌──────────┐     │      │  │
│  │      │      │           │    │LogWatcher│  │  World.*  │     │      │  │
│  │      │      │           │    │          │  │           │     │      │  │
│  │      │      │           │    │ RCON poll│  │ Effects   │     │      │  │
│  │      │      │           │    │ 2s tick  │  │ Display   │     │      │  │
│  │      │      │           │    │          │  │ Music     │     │      │  │
│  │      │      │           │    │ Detects: │  │ Redstone  │     │      │  │
│  │      │      │           │    │  joins   │  └──────────┘     │      │  │
│  │      │      │           │    │  leaves  │                    │      │  │
│  │      │      │           │    │  player  │  ┌──────────────┐ │      │  │
│  │      │      │           │    │  data    │  │ ModelCache   │ │      │  │
│  │      │      │           │    └────┬─────┘  │ (ETS + disk) │ │      │  │
│  │      │      │           │         │        │ Groq models  │ │      │  │
│  │      │      │           │         │        └──────────────┘ │      │  │
│  │      │      │           │         │ dispatches events       │      │  │
│  │      │      │           │         ▼                         │      │  │
│  │      │      │           │ ┌───────────────┐ ┌────────────┐ │      │  │
│  │      │      │           │ │ McFun.Events  │▶│ EventStore │ │      │  │
│  │      │      │           │ │ dispatch/2    │ │ Last 200   │ │      │  │
│  │      │      │           │ └───────────────┘ └────────────┘ │      │  │
│  │      │      │           │                                   │      │  │
│  │      │      │           │ ┌──────────────┐ ┌────────────┐  │      │  │
│  │      │      │           │ │ CostTracker  │ │ ChatLog    │  │      │  │
│  │      │      │           │ │ per-bot LLM  │ │ JSONL +    │  │      │  │
│  │      │      │           │ │ cost tracking │ │ ring buffer│  │      │  │
│  │      │      │           │ └──────────────┘ └────────────┘  │      │  │
│  │      │      │           └──────────────────────────────────┘      │  │
│  │      │      │                                                      │  │
│  └──────┼──────┼──────────────────────────────────────────────────────┘  │
│         │      │                                                         │
│  ┌─ Bot Fleet App (bot_farmer) ──────────────────────────────────────┐   │
│  │      │      │  depends on mc_fun (RCON, LLM, PubSub, Events)     │   │
│  │      │      │                                                     │   │
│  │      │      │  ┌─────────────────────────────────────────────┐   │   │
│  │      │      │  │  BotFarmer (facade API)                     │   │   │
│  │      │      │  │  spawn_bot, stop_bot, set_model, chat, ...  │   │   │
│  │      │      │  └──────────────────┬──────────────────────────┘   │   │
│  │      │      │                     │                               │   │
│  │      │      │  ┌──────────────────┴──────────────────────────┐   │   │
│  │      │      │  │  BotStore (fleet persistence)               │   │   │
│  │      │      │  │  priv/bot_fleet.json, auto-deploy on start  │   │   │
│  │      │      │  │  Debounced writes (3s)                      │   │   │
│  │      │      │  └─────────────────────────────────────────────┘   │   │
│  │      │      │                                                     │   │
│  │      │      │  ┌─────────────────────────────────────────────┐   │   │
│  │      │      │  │  McFun.Bot (per bot, DynamicSupervisor)     │   │   │
│  │      │      │  │                                             │   │   │
│  │      │      │  │  Erlang Port ◄──► bridge.js (Node.js)       │───┼─┐ │
│  │      │      │  │  JSON over stdin/stdout                     │   │ │ │
│  │      │      │  │                                             │   │ │ │
│  │      │      │  │  Actions: dig, place, goto, follow,         │   │ │ │
│  │      │      │  │    jump, attack, craft, equip, mine, ...    │   │ │ │
│  │      │      │  │  Status: pos (5s poll), HP, food            │   │ │ │
│  │      │      │  └─────────────────────────────────────────────┘   │ │ │
│  │      │      │                                                     │ │ │
│  │      │      │  ┌──────────────┐  ┌────────────────────┐          │ │ │
│  │      │      │  │McFun.ChatBot │  │McFun.BotBehaviors  │          │ │ │
│  │      │      │  │              │  │                    │          │ │ │
│  │      │      │  │ !ask !model  │  │ patrol (waypoints) │          │ │ │
│  │      │      │  │ !personality │  │ follow (player)    │          │ │ │
│  │      │      │  │ !tp !reset   │  │ guard  (pos+radius)│          │ │ │
│  │      │      │  │              │  │ mine   (block type) │          │ │ │
│  │      │      │  │ Groq API ────┼──┼───▶ LLM ──┐       │          │ │ │
│  │      │      │  │ Tool calling │  │    1s tick │       │          │ │ │
│  │      │      │  │ ActionParser │  │            │       │          │ │ │
│  │      │      │  └──────────────┘  └────────────┘       │          │ │ │
│  │      │      │                                          │          │ │ │
│  │      │      │  ┌──────────────────┐  ┌──────────────┐ │          │ │ │
│  │      │      │  │ BotRegistry      │  │ McFun.BotChat│ │          │ │ │
│  │      │      │  │ (Registry)       │  │ Bot-to-bot   │ │          │ │ │
│  │      │      │  │                  │  │ coordinator  │ │          │ │ │
│  │      │      │  │ Keys:            │  │ Topic inject │ │          │ │ │
│  │      │      │  │  "Name"     Bot  │  └──────────────┘ │          │ │ │
│  │      │      │  │  {:chat_bot,..}  │                    │          │ │ │
│  │      │      │  │  {:behavior,..}  │  ┌──────────────┐ │          │ │ │
│  │      │      │  │                  │  │ Presets (22)  │ │          │ │ │
│  │      │      │  └──────────────────┘  └──────────────┘ │          │ │ │
│  │      │      └─────────────────────────────────────────┘          │ │ │
│  │      │                                                            │ │ │
│  └──────┼──────┼─────────────────────────────────────────────────────┘ │ │
│         │      │                                                       │ │
│  ┌─ Web App (mc_fun_web) ──────────────────────────────────────────┼─┘ │
│  │      │      │  depends on bot_farmer + mc_fun                   │    │
│  │      │      │                                                    │    │
│  │  ┌───┴──────┴────────────────────────────────────────────┐      │    │
│  │  │  McFunWeb.Endpoint (:4000)                            │      │    │
│  │  │                                                       │      │    │
│  │  │  Routes:                                              │      │    │
│  │  │    /           → HomePage (static)                    │      │    │
│  │  │    /dashboard  → DashboardLive (LiveView)             │      │    │
│  │  │    /api/webhooks/:action → WebhookController          │      │    │
│  │  │                                                       │      │    │
│  │  │  ┌─────────────────────────────────────────────────┐  │      │    │
│  │  │  │  DashboardLive (parent LiveView)                │  │      │    │
│  │  │  │                                                 │  │      │    │
│  │  │  │  Tab routing, PubSub subs, shared state         │  │      │    │
│  │  │  │  Subscribes: bot:*, mc_events:all, player_*     │  │      │    │
│  │  │  │  Calls BotFarmer.* facade (never McFun.Bot etc) │  │      │    │
│  │  │  │                                                 │  │      │    │
│  │  │  │  LiveComponents (one per tab):                  │  │      │    │
│  │  │  │    UnitsPanelLive    — deploy, bot cards         │  │      │    │
│  │  │  │    RconConsoleLive   — terminal, quick cmds      │  │      │    │
│  │  │  │    EventStreamLive   — event log                 │  │      │    │
│  │  │  │    ChatPanelLive     — color-coded chat viewer    │  │      │    │
│  │  │  │    EffectsPanelLive  — effects, titles            │  │      │    │
│  │  │  │    DisplayPanelLive  — block text                 │  │      │    │
│  │  │  │    BotConfigModalLive — bot config modal          │  │      │    │
│  │  │  │                                                 │  │      │    │
│  │  │  │  Async: RCON cmds & LLM calls via Task.start   │  │      │    │
│  │  │  │    (results via send/2 to avoid blocking LV)    │  │      │    │
│  │  │  └─────────────────────────────────────────────────┘  │      │    │
│  │  └───────────────────────────────────────────────────────┘      │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  ┌─ CLI Tools (Mix Tasks) ─────────────────────────────────────────┐    │
│  │  mix mc.cmd      — RCON command        mix mc.status — health   │    │
│  │  mix mc.players  — list players        mix mc.events — stream   │    │
│  │  mix mc.say      — broadcast           mix mc.give   — give     │    │
│  │  mix mc.tp       — teleport            mix mc.weather — weather │    │
│  │  mix mc.time     — set time            mix mc.fx     — effects  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  ┌─ External ──────────────────────────────────────────────────────┐    │
│  │  Groq API  ◄── McFun.LLM.Groq (Req HTTP, 3 retries, backoff)  │    │
│  │  Models: openai/gpt-oss-20b (default), llama, qwen, etc.       │    │
│  └─────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘


App Dependency Graph
════════════════════

  mc_fun              (infrastructure: RCON, LLM, PubSub, Events, ChatLog, World)
    ^
    │
  bot_farmer          (bot runtime: Bot, ChatBot, BotBehaviors, BotChat + persistence)
    ^         ^
    │         │
  mc_fun_web ─┘       (dashboard: LiveView — depends on BOTH)


Data Flow: Player Chat → Bot Response
═══════════════════════════════════════

  Player types "!ask what's around you?"
       │
       ▼
  MC Server ──RCON poll──▶ LogWatcher detects chat
       │                        │
       │                        ▼ dispatch(:player_chat)
       │                   Events/PubSub
       │                        │
       │                        ▼
       │                   ChatBot receives
       │                        │
       │                   Bot.survey/1 ──▶ bridge.js ──▶ MC Server
       │                        │              nearby blocks, entities
       │                        │◄─────────────────────────────────────
       │                        │
       │                   Groq LLM API call
       │                   (with survey context + personality)
       │                        │
       │                        ▼
       │                   LLM response
       │                        │
       │               ┌────────┴────────┐
       │               │                 │
       │          Tool-capable?     ActionParser
       │          (tool calling)    (regex fallback)
       │               │                 │
       │               └────────┬────────┘
       │                        │
       │                   Bot.send_command
       │                        │
       │                   bridge.js ──▶ MC Server
       │                        │
       │                   Bot.chat (paginated)
       │                        │
       ▼                   bridge.js ──▶ MC Server
  Player sees bot                    (chat appears in game)
  perform action
  and respond


Player Data Fetching (LogWatcher)
═════════════════════════════════

  RCON: "execute as <player> run data get entity @s"
       │
       ▼
  Response truncated? (RCON limit ~512 chars)
       │
  ┌────┴────┐
  │ No      │ Yes (Health/Pos not found)
  │         │
  │ parse   │ Fallback: individual field queries
  │ full    │   "execute as <player> run data get entity @s Health"
  │ NBT     │   "execute as <player> run data get entity @s Pos"
  │ blob    │   "execute as <player> run data get entity @s Dimension"
  │         │   "execute as <player> run data get entity @s foodLevel"
  │         │
  └────┬────┘
       │
       ▼
  %{health: 16.6, food: 17, position: {-412, 62, 288}, dimension: "overworld"}
       │
       ▼
  PubSub broadcast "player_statuses" → DashboardLive updates
